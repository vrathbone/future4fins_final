---
title: "2_top_30_species"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#load packages
library(raster)
library(tidyverse)
library(sf)
library(here)
library(fasterize)
library(stringr)

```

### *STEP 1: Load Species Distribution Data from Aquamaps
Aquapmaps data is...
```{r}
## read in MZ EEZ tif
mz_rast_id <- raster(here("set_up/final_rasters/mz_eez_templates/mz_rast_id.tif"))

## read in hcaf data
hcaf_df<- read_csv(here('aquamaps/am_hcaf.csv')) #need to changed from aquamaps folders with Casey's permission

# hcaf_df <- read_csv(here("set_up", "csv_files", "hcaf_species_native.csv")) %>%
#   clean_names() %>% 
#   mutate(id=1:n())


## create an xyz dataframe for the raster::rasterFromXYZ function
xyz_df <- hcaf_df %>%
  select(x = center_long, y = center_lat, z = loiczid)


## create a raster from this dataframe
hcaf_rast <- raster::rasterFromXYZ(xyz_df)
crs(hcaf_rast) #check it (NA) --> must assign it
crs(hcaf_rast) <- '+init=epsg:4326' 

## change raster to be projected in the same extent and crs as mz_rast_id
hcaf_reproj <- raster::projectRaster(hcaf_rast, mz_rast_id, res = 10000,
                                            method = 'ngb',
                                            crs = crs(mz_rast_id))

#make the hcaf rast match the extent of the mz 
hcaf_mz_rast <- raster::crop(hcaf_reproj, mz_rast_id) 

## mask to just include the EEZ
hcaf_mz_rast <-  mask(hcaf_mz_rast, mz_rast_id)

plot(hcaf_mz_rast)

```

### *STEP 2: Filter data to only include focal species*
```{r}
#read in species file data
mz <- read_csv(here("aquamaps","moz_spp_native.csv")) #need to changed from aquamaps folders with Casey's permission
mz_info <- read_csv(here("aquamaps","moz_spp_info.csv"))

# mz_new <- read_csv(here("set_up", "csv_files", "speciesoccursum.csv"))

mz_snr_species <- mz %>%
   filter(am_sid %in% c("Fis-31568",
                       "Fis-23898",
                       "Fis-23899",
                       "Fis-23061",
                       "Fis-23064",
                       "Fis-23071",
                       "Fis-58485",
                       "Fis-29423",
                       "Fis-29388",
                       "Fis-30583",
                       "Fis-23273",
                       "Fis-23274",
                       "Fis-23277",
                       "Fis-8339",
                       "Fis-47352",
                       "Fis-24098",
                       "Fis-163295",
                       "Fis-61508",
                       "Fis-30521",
                       "Fis-32599",
                       "Fis-131821",
                       "Fis-32975"))

#filter using the top 30 species id
# mz_snr_species <- hcaf_df %>%
#   filter(species_id %in% c("Fis-31568", # Alopias pelagicus 1
#                        "Fis-23898",  # Alopias superciliosus 2
#                        "Fis-23899",  # Alopias vulpinus 3
#                        "Fis-23061",  # Carcharhinus longimanus 4
#                        "Fis-23064",  # Carcharhinus obscurus 5
#                        "Fis-23071",  # Carcharodon carcharias 6
#                        "Fis-58485",  # Isurus oxyrinchus 7
#                        "Fis-29423",  # Isurus paucus 8
#                        "Fis-29388",  # Carcharias taurus 9
#                        "Fis-30583",  # Rhincodon typus 10
#                        "Fis-23273",  # Sphyrna lewini 11
#                        "Fis-23274",  # Sphyrna mokarran 12
#                        "Fis-23277",  # Sphyrna zygaena 13
#                        "Fis-8339",   # Stegostoma fasciatum 14
#                        "Fis-61508",  # Mobull kuhlii 15
#                        "Fis-30521",  # Pristis microdon/pristis pristis 24 (double check)
#                        "Fis-58414",  # Pseudoginglymostoma brevicaudatum 16
#                        "Fis-172567", # Manta birostris 17
#                        "Fis-35514",  # Mobula tarapacana 18
#                        "Fis-24127",  # Mobula thurstoni 19
#                        "Fis-32599",  # Pristis zijsron 20
#                        "Fis-131821", # Rostroraja alba 21
#                        "Fis-32975",  # Rhina ancylostomus 22
#                        "Fis-25664",  # Rhynchobatus djiddensis 23
#                        "Fis-172376", # Megatrygon microps 25
#                        "Fis-172566")) %>% # Mobula alfredi 26
#   select(sp_id = species_id, probability,id)
    
```

### *STEP 3: Create a Function that clips each species distribution map to MZ EEZ and saves as tiff*
```{r}
#create raster function by species id
# create_rast <- function(mz_snr_species, species_id){
#   outfile <- sprintf(here('set_up/final_rasters/conservation_features/species/species_%s.tif'), species_id)
#   message('Processing species ', species_id, ' to create file ', outfile)
#   
#   species_df <- mz_snr_species %>%
#   filter(sp_id == species_id)
# 
# ### use raster::subs() to substitute in values for others
# species_rast <- subs(hcaf_mz_rast, species_df,
#                       by = 'id', ### which variable is the key
#                       which = 'probability') %>% 
#   trim()
# 
# writeRaster(species_rast, filename = outfile, overwrite = TRUE)
# 
# return('yay it works')
# 
# }

# #create raster function by species id
create_rast <- function(mz, species_id){
  outfile <- sprintf(here('set_up/final_rasters/conservation_features/species/species_%s.tif'), species_id)
  message('Processing species ', species_id, ' to create file ', outfile)

  species_df <- mz %>%
  filter(am_sid == species_id)

### use raster::subs() to substitute in values for others
species_rast <- subs(hcaf_mz_rast, species_df,
                      by = 'loiczid', ### which variable is the key
                      which = 'prob') %>%
  trim()

writeRaster(species_rast, filename = outfile, overwrite = TRUE)

return('yay it works')

}

```

### *STEP 4: Create vector of the focal species*
```{r}
#creating a vector of the top 30 species to be used in a loop
species_vec <- c("Fis-31568",
                       "Fis-23898",
                       "Fis-23899",
                       "Fis-23061",
                       "Fis-23064",
                       "Fis-23071",
                       "Fis-58485",
                       "Fis-29423",
                       "Fis-29388",
                       "Fis-30583",
                       "Fis-23273",
                       "Fis-23274",
                       "Fis-23277",
                       "Fis-8339",
                       "Fis-47352",
                       "Fis-24098",
                       "Fis-163295",
                       "Fis-61508",
                       "Fis-30521",
                       "Fis-32599",
                       "Fis-131821",
                       "Fis-32975")

# species_vec <- c("Fis-31568", # Alopias pelagicus 1
#                        "Fis-23898",  # Alopias superciliosus 2
#                        "Fis-23899",  # Alopias vulpinus 3
#                        "Fis-23061",  # Carcharhinus longimanus 4
#                        "Fis-23064",  # Carcharhinus obscurus 5
#                        "Fis-23071",  # Carcharodon carcharias 6
#                        "Fis-58485",  # Isurus oxyrinchus 7
#                        "Fis-29423",  # Isurus paucus 8
#                        "Fis-29388",  # Carcharias taurus 9
#                        "Fis-30583",  # Rhincodon typus 10
#                        "Fis-23273",  # Sphyrna lewini 11
#                        "Fis-23274",  # Sphyrna mokarran 12
#                        "Fis-23277",  # Sphyrna zygaena 13
#                        "Fis-8339",   # Stegostoma fasciatum 14
#                        "Fis-61508",  # Mobull kuhlii 15
#                        "Fis-30521",  # Pristis microdon/pristis pristis 24 (double check)
#                        "Fis-58414",  # Pseudoginglymostoma brevicaudatum 16
#                        "Fis-172567", # Manta birostris 17
#                        "Fis-35514",  # Mobula tarapacana 18
#                        "Fis-24127",  # Mobula thurstoni 19
#                        "Fis-32599",  # Pristis zijsron 20
#                        "Fis-131821", # Rostroraja alba 21
#                        "Fis-32975",  # Rhina ancylostomus 22
#                        "Fis-25664",  # Rhynchobatus djiddensis 23
#                        "Fis-172376", # Megatrygon microps 25
#                        "Fis-172566")
```

### *STEP 5: Create & run loop with vector*
```{r}
#creating a loop of create_rast function to get all the rasters at once 
# for (i in seq_along(species_vec)) {
#   create_rast(mz_snr_species, species_vec[i])
# }

for (i in seq_along(species_vec)) {
  create_rast(mz, species_vec[i])
}

```


Additional Exploration: looking at SNR species richness and associated probabilities
```{r}
## map out the shark species richness, summary of species in each cell ID with mean of probability (suitability) --> instead mapping the mean probability for each cell 

## creating dataframe that only contains that top 30 species and counts how many are "present" in each cell and their mean probability
shark_richness_df <- mz_snr_species %>%
  group_by(loiczid) %>%
  summarize(n_sharks = n_distinct(am_sid), prob = mean(prob))

## create a raster  
shark_richness_rast <- raster::subs(hcaf_mz_rast, shark_richness_df, 
                                    by = 'loiczid', which = 'prob')
plot(shark_richness_rast)

## create a dataframe and plot using ggplot
shark_map_df <- rasterToPoints(shark_richness_rast) %>%
  as.data.frame()

## must read in mz_eez_sf to plot
# ggplot() +
#   geom_raster(data = shark_map_df, aes(x, y, fill = prob)) +
#   geom_sf(data = mz_eez_sf, color = 'yellow', fill = NA)  


```

Citations:
 - 
 
Outputs:
 - `mz_snr_species` = tidy data frame that contains forcal species by id 
 - `hcaf_mz_rast` = raster of the mz hcaf used to create the species rasters
 - `species_Fis-#####` = tif files of each focal species to be used (22 total)
 
End script.

